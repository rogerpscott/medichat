if ($('#kapor').text().length) {
  var abc = $('#kapor').text();
  App.messages = App.cable.subscriptions.create({channel: 'MessagesChannel', access_token: abc}, {
    received: function(data) {
      $("#messages").not(".hidden #messages").removeClass('hidden')
      return $('#messages').not(".hidden #messages").append(this.renderMessage(data));
    },
    renderMessage: function(data) {
    if(window.location.href.indexOf("doctor") > 0) {
        var notificationEvents = ['onclick', 'onshow', 'onerror', 'onclose'];
        var title = data.user + " mand√≥ un mensaje";
        var options = {
          body: data.message,
          tag: data.user,
          requireInteraction: true
        };
        Notification.requestPermission(function() {
          if (title.substring(0,3) == "Dr."){
            console.log("ok");
            // En la vista del doctor el mensaje del doctor
            return '<div class="item-chat"><div class="dd patient-box-chat-box-chat"><div class="pull-right"><strong>'+ data.user +' - Paciente </strong><div><p class="patient-box-chat-text-chat"> '+ data.message +'</p></div></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
          } else {
            var notification = new Notification(title, options);

            notificationEvents.forEach(function(eventName) {
              notification[eventName] = function(event) {
                console.log(data.message)
              };
            });
            notification.onclick = function(event) {
              parent.focus();
              window.focus();
              this.close();
            }
          // En la vista del doctor el mensaje del paciente
          return '<div class="item-chat"><div class="dd doctor-box-chat"><div class="pull-right"><strong>'+ data.user +' - Paciente </strong><div><p class="doctor-text-chat"> '+ data.message +'</p></div></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
          }
        });
      }
      else {
        if (title.substring(0,3) == "Dr."){
          // En la vista del paciente el mensaje del doctor
          return '<div class="item-chat"><div class="dd doctor-box-chat"><div class="pull-right"><strong>'+ data.user +' - Paciente </strong><div><p class="doctor-text-chat"> '+ data.message +'</p></div></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
        }
        else {
          // En la vista del paciente el mensaje del paciente
          return '<div class="item-chat"><div class="dd patient-text-chat-box-chat"><div class="pull-right"><strong>'+ data.user +' - Paciente </strong><div><p class="patient-text-chat-text-chat"> '+ data.message +'</p></div></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
        }
    }
  });
}


